<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta property="og:type" content="article"/>
<title>ardatasc.github.io</title>
<link rel="icon" href="../../favicon.png" type="image/x-icon">
<link rel="preconnect" href="https://fonts.googleapis.com/">
<link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
<link rel="preconnect" href="https://fonts.googleapis.com/">
<link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&display=swap.css" rel="stylesheet">
<link rel="preconnect" href="https://fonts.googleapis.com/">
<link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&amp;display=swap" rel="stylesheet">
<link rel="stylesheet" href="../../theme.min.7363202e6ba39c3b4caca8b218f6f6631256ed7a41cd2f8bf46550651b07cb31.css" integrity="">
</head>
<body>
  <div class="header">
  <div class="header-content">
  <div class="header-content-title">
  ardatasc
  </div>
  <div class="header-content-nav">
  <div class="header-content-nav-item">
  <a href="../../c.html">content</a>
  </div>
  <div class="header-content-nav-item">
  <a href="../../about.html">about</a>
  </div>
  </div>
  </div>
  </div>
<div class="content-container">
<div class="content"><h1 id="linux-workstation-setup-xps-arch-windows-encrypted">Linux Workstation Setup: XPS, Arch, Windows, Encrypted</h1>
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
<iframe src="https://web.archive.org/web/20240228145207if_/https://www.youtube.com/embed/Q4XfaJY2TZo" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>
<h2 id="laptop">Laptop</h2>
<p>My workstation is a Dell XPS. The specs are:</p>
<ul>
<li>Processor: 11th Gen i7-11800H</li>
<li>Memory: 64 GB, 2 x 32 GB, DDR4, 3200 MHz</li>
<li>Hard Drive: 2 TB, M.2, PCIe NVMe, SSD</li>
<li>Dedicated Graphics: RTX 3050</li>
<li>Display: FHD+ (1920x1200) Non-touch</li>
</ul>
<p>I choose XPS as it is a familiar laptop with a keyboard and trackpad I like. I
choose one with an 11th Gen Intel chip even though the Intel 12th gen CPUs are
available. These feature the performance (p) and efficiency (e) cores. While I
am excited about this architecture, <a href="https://web.archive.org/web/20240228145207/https://www.phoronix.com/scan.php?page=news_item&amp;px=Intel-HFI-For-Linux-5.18">Intel’s thread director is not planned to
be available in the Linux kernel until
5.18</a>.
The memory size is largely unnecessary, but I do use <code>qemu</code> to spin up and down
multiple VMs, so the extra headroom is nice. With 2TB of disk space, I can have
Windows and Linux installed with ~1TB available to each. The dedicated graphics
are leveraged to offload video rendering. Otherwise, I try to use integrated
graphics (for the sake of battery). Lastly, the display is the less-nice
non-OLED (FHD+) option. While a lesser display, it has significantly less power
draw and removes the touch feature set. Lastly, being Dell, the BIOS-level
settings on this workstation can be a pain for Linux. If you’re looking for a
purely Linux workstation, I recommend <a href="https://web.archive.org/web/20240228145207/https://system76.com/laptops">System 76</a>.</p>
<h2 id="installation-preparation">Installation Preparation</h2>
<p>For installation media, use 2 USB flash drives, one for Linux and one for
Windows.</p>
<h3 id="linux-install-media">Linux Install Media</h3>
<p>For Arch Linux, you can download the ISO at
<a href="https://web.archive.org/web/20240228145207/https://archlinux.org/download/">archlinux.org/download</a>. From here, choose
mirror. For my location, I find the <a href="https://web.archive.org/web/20240228145207/https://mirrors.mit.edu/archlinux/iso/">mit.edu
mirror</a> to be good. To setup the
downloaded ISO:</p>
<ol>
<li>
<p>Insert the USB drive to your machine.</p>
</li>
<li>
<p>List block devices to determine the device name.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ lsblk
</span></span><span class="line"><span class="cl">NAME                    MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
</span></span><span class="line"><span class="cl">sda                       8:0    <span class="m">1</span>  29.2G  <span class="m">0</span> disk
</span></span><span class="line"><span class="cl"><span class="p">|</span>-sda1                    8:1    <span class="m">1</span>   602M  <span class="m">0</span> part
</span></span><span class="line"><span class="cl"><span class="sb">`</span>-sda2                    8:2    <span class="m">1</span>    64M  <span class="m">0</span> part
</span></span><span class="line"><span class="cl">nvme0n1                 259:0    <span class="m">0</span>   477G  <span class="m">0</span> disk
</span></span><span class="line"><span class="cl"><span class="p">|</span>-nvme0n1p1             259:1    <span class="m">0</span>   512M  <span class="m">0</span> part  /boot
</span></span><span class="line"><span class="cl"><span class="sb">`</span>-nvme0n1p2             259:2    <span class="m">0</span> 476.4G  <span class="m">0</span> part
</span></span><span class="line"><span class="cl">  <span class="sb">`</span>-cryptroot<span class="se">\x</span>5cx2callow-discards<span class="se">\x</span>5cx2cheader
</span></span><span class="line"><span class="cl">                        254:0    <span class="m">0</span> 476.4G  <span class="m">0</span> crypt
</span></span><span class="line"><span class="cl">    <span class="sb">`</span>-vg0-root          254:1    <span class="m">0</span> 476.4G  <span class="m">0</span> lvm   /
</span></span></code></pre></div><blockquote>
<p>Based on the above, the drive is located at <code>dev/sda</code>.</p>
</blockquote>
</li>
<li>
<p>Write the ISO contents to the USB drive.</p>
<p><code>bash cat ~/Downloads/${ARCH_ISO_FILE_NAME}.iso &gt; /dev/sda</code></p>
<blockquote>
<p>cat points at the disk, <code>/dev/sda</code>. It should <strong>not</strong> point at a partition
(e.g. <code>/dev/sda1</code>).</p>
</blockquote>
</li>
<li>
<p>Remove the USB drive.</p>
</li>
</ol>
<h3 id="windows-install-media">Windows Install Media</h3>
<p>For Windows, <a href="https://web.archive.org/web/20240228145207/http://ventoy.net/">Ventoy</a> is used to create the installation
media. Its primary use is to disable hardware checks in Windows, namely <a href="https://web.archive.org/web/20240228145207/https://docs.microsoft.com/en-us/windows-hardware/design/device-experiences/oem-secure-boot">secure
boot</a>.
To get setup for the installation media, you should:</p>
<ol>
<li>
<p><a href="https://web.archive.org/web/20240228145207/https://www.ventoy.net/en/download.html">Download and install Ventoy</a>.</p>
</li>
<li>
<p><a href="https://web.archive.org/web/20240228145207/https://www.microsoft.com/software-download/windows11">Download the Windows 11 <strong>ISO</strong>
image</a>.</p>
<p><img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/w11-download.png" alt="Install Windows 11"></p>
</li>
</ol>
<p>With the above in place, you can setup the installation media by:</p>
<ol>
<li>
<p>Launch <code>ventoygui</code>.</p>
</li>
<li>
<p>Choose your USB stick from the drop-down.</p>
</li>
<li>
<p>Click Install.</p>
</li>
<li>
<p>Close <code>ventoygui</code>.</p>
</li>
<li>
<p>Mount the partition made by <code>ventoygui</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># mount /dev/sda1 /run/media/josh/ventoy</span>
</span></span></code></pre></div><blockquote>
<p>Assumes <code>ventoy</code> exists in your path.</p>
</blockquote>
</li>
<li>
<p>Run <code>ventoyplugson</code> against this mount.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ventoyplugson /dev/sda1
</span></span></code></pre></div></li>
<li>
<p>Open the address provided by <code>ventoyplugson</code>.</p>
</li>
<li>
<p>In <code>Global Control Plugin</code> set <code>VTOY_WIN11_BYPASS_CHECK</code> to <code>1</code> (on).</p>
<p><img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/vtoy.png" alt="ventoy gui"></p>
<blockquote>
<p>This will ensure we can install Windows 11 with secure boot disabled
(required for the Linux install). It will also allow you to install
Windows on a machine that does not meet Microsft's hardware requirements.</p>
</blockquote>
</li>
<li>
<p>Exit <code>ventoyplugson</code>.</p>
</li>
<li>
<p>Remove the USB drive.</p>
</li>
</ol>
<h3 id="bios-setup">BIOS Setup</h3>
<p>On most modern motherboards, you'll need to disable secure boot in the BIOS.
This is primarily to support the Linux install, however <a href="https://web.archive.org/web/20240228145207/https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface/Secure_Boot#Implementing_Secure_Boot">there are ways to do a
Linux install with secure boot
enabled</a>.
On modern Dell laptops, Intel Rapid Storage (via RAID) is turned on by default.
The primary use of this feature is to emulate RAID storage, however, it really
doesn't serve much purpose on this single SSD laptop. Thus, I recommend setting
the SATA mode to AHCI/NVMe. To setup the BIOS:</p>
<ol>
<li>
<p>Boot into the one-time-boot menu by holding F12 during boot.</p>
</li>
<li>
<p>Select the BIOS option.</p>
</li>
<li>
<p>In <code>Boot Configuration</code> &gt; <code>Secure Boot</code>, disable secure boot.</p>
<p><img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/secure-boot.png" alt="BIOS secure boot"></p>
</li>
<li>
<p>From <code>Storage</code> &gt; <code>SATA/NVMe Operation</code>, set the mode to <code>AHCI/NVMe</code>.</p>
<p><img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/nvme.png" alt="BIOS AHCI/NVMe operation"></p>
</li>
<li>
<p>Apply Changes and power down.</p>
</li>
</ol>
<h3 id="disk-partition-layout">Disk (Partition) Layout</h3>
<p>This laptop will run Windows 11 and Arch Linux. Both operating systems will be
fully encrypted. The partition layout will be as follows:</p>
<p><img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/part.png" alt="Partition Scheme"></p>
<blockquote>
<p>I've intentionally left out some partitions that will be created by Linux.</p>
</blockquote>
<p>It's worth noting that I do <strong>not</strong> reserve space for swap in Linux. For many
Linux-laptop users, swap is highly preferred as it enables their computer to
Hibernate. You may want to look into the benefits of Hibernate to determine if
you'd like an extra partition for swap.</p>
<h2 id="windows-install">Windows Install</h2>
<p>Windows installation comes first as it will layout the disk in a way that Linux
can add to. Once Windows is installed, Veracrypt will be used to encrypt its
volume.</p>
<ol>
<li>
<p>Insert the USB drive containing the (Ventoy) Windows ISO.</p>
</li>
<li>
<p>Boot into the one-time-boot menu by holding F12 during boot.</p>
</li>
<li>
<p>Select USB from the left navigation.</p>
</li>
<li>
<p>Select the language to install and click Next.</p>
</li>
<li>
<p>Click Install now.</p>
</li>
<li>
<p>Accept the license terms and click Next.</p>
</li>
<li>
<p>Click Custom: Install Windows only (advanced).</p>
</li>
<li>
<p>Delete all existing partitions.</p>
<a href="https://web.archive.org/web/20240228145207/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/deleted-windows-partitions.png" target="octetz-img">
<img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/deleted-windows-partitions.png" width="600">
</a>
</li>
<li>
<p>Create a new partition of the size you'd like Windows to occupy.</p>
<a href="https://web.archive.org/web/20240228145207/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/click-new-windows.png" target="octetz-img">
<img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/click-new-windows.png" width="250">
</a>
<blockquote>
<p>Windows creates additoinal partitions including the 100.0MB System partition that will act as the EFI partition.</p>
</blockquote>
</li>
<li>
<p>Click Next and wait for Windows to install.</p>
<a href="https://web.archive.org/web/20240228145207/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/windows-made-partitions.png" target="octetz-img">
<img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/windows-made-partitions.png" width="250">
</a>
<blockquote>
<p>After the installation completes, the machine will reboot.</p>
</blockquote>
</li>
<li>
<p>After reboot, go through the Windows setup procedure.</p>
</li>
</ol>
<h3 id="disable-fast-boot">Disable Fast Boot</h3>
<p>Once Windows has been installed and configured you're able to boot into it. The
next step is to turn off the fast boot feature. This feature can cause issues
with partitions shared between Windows and Linux. To disable fast boot:</p>
<ol>
<li>
<p>Open Control Panel.</p>
</li>
<li>
<p>In the top right search, enter <code>power</code>.</p>
<a href="https://web.archive.org/web/20240228145207/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/control-panel.png" target="octetz-img">
<img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/control-panel.png" width="600">
</a>
</li>
<li>
<p>Click <code>Change what the power buttons do</code>.</p>
</li>
<li>
<p>Click <code>Change settings that are unavailable</code>.</p>
</li>
<li>
<p>Uncheck <code>Turn on fast startup (recommended)</code>.</p>
<a href="https://web.archive.org/web/20240228145207/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/disable-fast-startup.png" target="octetz-img">
<img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/disable-fast-startup.png" width="600">
</a>
<blockquote>
<p>To understand why fast startup is not recommended, see
<a href="https://web.archive.org/web/20240228145207/https://wiki.archlinux.org/index.php/Dual_boot_with_Windows#Fast_Start-Up">https://wiki.archlinux.org/index.php/Dual_boot_with_Windows#Fast_Start-Up</a></p>
</blockquote>
</li>
<li>
<p>Open Start &gt; Settings &gt; Update &amp; Security and Check for updates.</p>
</li>
<li>
<p>Allow all Windows updates to download and install before proceeding.</p>
</li>
</ol>
<h3 id="encrypt-the-windows-volume">Encrypt the Windows Volume</h3>
<p>With Window fully configured, you can now encrypt its volume. VeraCrypt provides
a free and open source way to encrypt the volume. After setting this up, the
bootloader will boot to VeraCrypt, which will then prompt the user to decrypt
the drive. If the user providers the correct password, the drive is decrypted
and Windows is booted. To encrypt the Window volume:</p>
<ol>
<li>
<p>Download and install VeraCrypt.</p>
<p><a href="https://web.archive.org/web/20240228145207/https://www.veracrypt.fr/en/Downloads.html">https://www.veracrypt.fr/en/Downloads.html</a></p>
</li>
<li>
<p>Launch VeraCrypt.</p>
</li>
<li>
<p>From the menu bar, open System &gt; Encrypt System Partition/Drive</p>
<a href="https://web.archive.org/web/20240228145207/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/veracrypt-encrypt-system.png" target="octetz-img">
<img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/veracrypt-encrypt-system.png" width="600">
</a>
</li>
<li>
<p>Choose Normal.</p>
<a href="https://web.archive.org/web/20240228145207/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/veracrypt-normal.png" target="octetz-img">
<img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/veracrypt-normal.png" width="600">
</a>
</li>
<li>
<p>Choose Encrypt the Windows system partition.</p>
<a href="https://web.archive.org/web/20240228145207/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/encrypt-system-part.png" target="octetz-img">
<img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/encrypt-system-part.png" width="600">
</a>
</li>
<li>
<p>Choose Single-boot.</p>
<a href="https://web.archive.org/web/20240228145207/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/single-boot.png" target="octetz-img">
<img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/single-boot.png" width="600">
</a>
<blockquote>
<p>While you will have a multi-boot system eventually. This installation will have grub point
to veracrypt that will then decrypt and point to windows. Thus, vercrypt needs to know
nothing about Linux.</p>
</blockquote>
</li>
<li>
<p>Choose your preferred encryption algorithm and click Next.</p>
</li>
<li>
<p>Create a strong password.</p>
</li>
<li>
<p>Allow VeraCrypt to collect random data.</p>
</li>
<li>
<p>If desired, create a rescue disk.</p>
<blockquote>
<p>This will require a USB drive to save to.</p>
</blockquote>
</li>
<li>
<p>Choose your preferred Wipe Mode.</p>
</li>
<li>
<p>Run the System Encryption Pretest.</p>
<blockquote>
<p>This will require your machine to be restarted.</p>
</blockquote>
</li>
<li>
<p>Upon restart, enter your encryption password when prompted.</p>
</li>
<li>
<p>Log back in to your Windows system.</p>
</li>
<li>
<p>VeraCrypt will pop back up to tell you the Pretest Completed.</p>
<a href="https://web.archive.org/web/20240228145207/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/encrypt.png" target="octetz-img">
<img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/encrypt.png" width="600">
</a>
</li>
<li>
<p>Click Encrypt and run the encryption.</p>
<blockquote>
<p>This will encrypt the file system and take several minutes.</p>
</blockquote>
</li>
<li>
<p>Allow the encryption to complete.</p>
<a href="https://web.archive.org/web/20240228145207/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/encrypting.png" target="octetz-img">
<img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/encrypting.png" width="600">
</a>
</li>
<li>
<p>Power off the machine.</p>
</li>
</ol>
<h2 id="linux-install">Linux Install</h2>
<p>Arch Linux will be installed using the disk space left over from Windows. We'll
use the installer to setup the partitions, encrypt root, and finally bootstrap
the initial system. To start installing Arch Linux:</p>
<ol>
<li>
<p>Insert the USB containing the Arch Linux ISO.</p>
</li>
<li>
<p>Boot into the one-time-boot menu by holding F12 during boot.</p>
</li>
<li>
<p>Select the USB device and allow the Arch installer to boot.</p>
</li>
</ol>
<p>The default Arch install requires internet connection to discover and install
packages. Wired connections should work by default. If using a wireless
connection:</p>
<ol>
<li>
<p>Run <code>iwctl</code> to managed wireless networks.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ iwctl
</span></span></code></pre></div></li>
<li>
<p>Locate the name of your wireless device.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ device list
</span></span></code></pre></div></li>
<li>
<p>Connect to the wireless network by its name.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ station <span class="si">${</span><span class="nv">DEVICE_NAME</span><span class="si">}</span> connect <span class="si">${</span><span class="nv">NETWORK_NAME</span><span class="si">}</span>
</span></span></code></pre></div></li>
<li>
<p>Validate connectivity.</p>
<pre tabindex="0"><code>ping google.com

PING google.com (216.58.193.206) 56(84) bytes of data.
64 bytes from lax02s23-in-f14.1e100.net time=809 ms
64 bytes from lax02s23-in-f14.1e100.net time=753 ms
</code></pre></li>
</ol>
<h3 id="ssh-into-installer">SSH into Installer</h3>
<p>Once network is setup, I prefer to complete the installation on a second
computer. This providers greater flexibility to use a browser, copy/paste, and
more. To setup <code>ssh</code> and finish the install from another host:</p>
<ol>
<li>
<p>Set a root passwd for <code>root</code>.</p>
<pre tabindex="0"><code>passwd
</code></pre></li>
<li>
<p>Enable <code>sshd</code>.</p>
<pre tabindex="0"><code>systemctl start sshd
</code></pre><blockquote>
<p>This may be enabled by default.</p>
</blockquote>
<a href="https://web.archive.org/web/20240228145207/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/ssh-install.png" target="octetz-img">
<img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/ssh-install.png" width="600">
</a>
</li>
<li>
<p>Determine your local address using <code>ip a</code>.</p>
</li>
<li>
<p>From another computer, ssh in.</p>
<pre tabindex="0"><code>ssh root@${TARGET_MACHINE_IP}
</code></pre>
<a href="https://web.archive.org/web/20240228145207/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/in-other-machine.png" target="octetz-img">
<img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/in-other-machine.png" width="600">
</a>
</li>
</ol>
<h3 id="disk-partitioning">Disk Partitioning</h3>
<ol>
<li>
<p>List block devices to determine the name of the drive.</p>
<pre tabindex="0"><code>lsblk

NAME                                            MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
nvme0n1                                         259:0    0   477G  0 disk
|-nvme0n1p1                                     259:1    0   512M  0 part  /boot
`-nvme0n1p2                                     259:2    0 476.4G  0 part
  `-cryptroot\x5cx2callow-discards\x5cx2cheader 254:0    0 476.4G  0 crypt
    `-vg0-root                                  254:1    0 476.4G  0 lvm   /
</code></pre><p>In the above, the drive is mapped to <code>/dev/nvme0n1</code>.</p>
</li>
<li>
<p>Launch cgdisk for the drive above.</p>
<pre tabindex="0"><code>cgdisk /dev/nvme0n1
</code></pre><blockquote>
<p><code>cgdisk</code> is an ncurses-based GUID partition table manipulator. Unlike the command-only <code>fdisk</code>
approach, <code>cgdisk</code> provides a text-menu for writing partitions.</p>
</blockquote>
</li>
<li>
<p>Select the free space.</p>
</li>
<li>
<p>Choose <code>[ New ]</code>.</p>
<a href="https://web.archive.org/web/20240228145207/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/cgdisk1.png" target="octetz-img">
<img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/cgdisk1.png" width="600">
</a>
</li>
<li>
<p>Enter no value for First sector (chooses default).</p>
<blockquote>
<p>This means the Linux partition starts directly at the end of the Windows partition. Some
believe it is best to leave a small amount of free space between partitions. However, I have
not had issues with this.</p>
</blockquote>
</li>
<li>
<p>Enter 512Mib for size in sectors.</p>
<blockquote>
<p>This is the end size of the partition.</p>
</blockquote>
</li>
<li>
<p>Enter no value for Hex code or GUID (chooses default).</p>
<blockquote>
<p>Default is 8300, Linux filesystem. A list can be found at
<a href="https://web.archive.org/web/20240228145207/https://gist.github.com/gotbletu/a05afe8a76d0d0e8ec6659e9194110d2">https://gist.github.com/gotbletu/a05afe8a76d0d0e8ec6659e9194110d2</a></p>
</blockquote>
</li>
<li>
<p>Name the partition <code>boot</code>.</p>
<a href="https://web.archive.org/web/20240228145207/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/cgdisk2.png" target="octetz-img">
<img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/cgdisk2.png" width="600">
</a>
</li>
<li>
<p>Note the partition number of the EFI System partition. This will be referenced later when
configuring grub. In the screenshots above, it is partition 2. On <strong>Windows
11</strong> installs I've done, I have found this can be partition 1.</p>
</li>
<li>
<p>Select the free space.</p>
</li>
<li>
<p>Choose <code>[ New ]</code>.</p>
</li>
<li>
<p>Enter no value for First sector (chooses default).</p>
</li>
<li>
<p>Enter no value for size in sectors (chooses default).</p>
<blockquote>
<p>This will fill the remaining disk.</p>
</blockquote>
</li>
<li>
<p>Enter no value for Hex code or GUID (chooses default).</p>
</li>
<li>
<p>Name the partition <code>root</code>.</p>
<a href="https://web.archive.org/web/20240228145207/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/cgdisk3.png" target="octetz-img">
<img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/cgdisk3.png" width="600">
</a>
</li>
<li>
<p>Choose <code>[ Write ]</code> and say yes.</p>
</li>
<li>
<p>Choose <code>[ Quit ]</code>.</p>
</li>
</ol>
<h3 id="encrypting-and-configuring-the-root-partition">Encrypting and Configuring the Root Partition</h3>
<p>With the partitions setup, the root partition can be encrypted. Once encrypted,
a device mapper <code>/dev/mapper/*</code> will be used to interact with the partition. To
perform the encryption:</p>
<ol>
<li>
<p>Encrypt the root partition.</p>
<pre tabindex="0"><code>cryptsetup -y --use-random luksFormat /dev/nvme0n1p6
</code></pre><blockquote>
<p>At the confirmation prompt, be sure to type <code>YES</code> in uppercase.</p>
</blockquote>
<ul>
<li><code>-y</code>: interactively requests the passphrase twice.</li>
<li><code>--use-random</code>: uses /dev/random to produce keys.</li>
<li><code>luksFormat</code>: initializes a LUKS partition.</li>
</ul>
</li>
<li>
<p>Open the LUKS device</p>
<pre tabindex="0"><code>cryptsetup luksOpen /dev/nvme0n1p6 cryptroot
</code></pre><ul>
<li><code>luksOpen</code>: Opens the LUKS device and creates a mapping in <code>/dev/mapper</code>.</li>
</ul>
</li>
<li>
<p>Run lsblk to view the new volume relationship.</p>
</li>
<li>
<p>Format the boot partitions as an <code>ext4</code> file system.</p>
<pre tabindex="0"><code>mkfs.ext4 /dev/nvme0n1p5
</code></pre></li>
<li>
<p>Format the cryptroot as a <code>ext4</code> file system.</p>
<pre tabindex="0"><code>mkfs.ext4 /dev/mapper/cryptroot
</code></pre></li>
</ol>
<h3 id="mounting-and-installing-linux">Mounting and Installing Linux</h3>
<p>With the filesystems in place, we need to mount the partitions to the local
files system (in <code>/mtn</code>) to begin writing to them. Once mounted, we'll be able
to use <code>pacstrap</code> which is like a version of <code>pacman</code> that installs packages
against a root filesystem you specify. To do perform these mounts and install:</p>
<ol>
<li>
<p>Mount cryptroot at <code>/mnt</code>.</p>
<pre tabindex="0"><code>mount /dev/mapper/cryptroot /mnt
</code></pre></li>
<li>
<p>Create a <code>boot</code> directory at root.</p>
<pre tabindex="0"><code>mkdir /mnt/boot
</code></pre></li>
<li>
<p>Mount the boot directory to the boot partition.</p>
<pre tabindex="0"><code>mount /dev/nvme0n1p5 /mnt/boot
</code></pre></li>
<li>
<p>Create an <code>efi</code> directory in <code>/mnt/boot</code>.</p>
<pre tabindex="0"><code>mkdir /mnt/boot
</code></pre></li>
<li>
<p>Mount the Window's created EFI partition to <code>/mnt/boot</code>.</p>
<pre tabindex="0"><code>mount /dev/nvme0n1p2 /mnt/boot/efi
</code></pre><blockquote>
<p>This is the partition you noted in the Disk Partitioning section.</p>
</blockquote>
</li>
<li>
<p>Edit the mirrors file <code>/etc/pacman.d/mirrorlist</code> with preferred mirrors from
<a href="https://web.archive.org/web/20240228145207/https://octetz.com/c/xps-arch-w11/archlinux.org/mirrorlist">archlinux.org/mirrorlist</a>.</p>
<blockquote>
<p>Setting mirrors that are reliable and fast are key as these mirrors will be
used for your initial install and setup as the default mirrors for your
package installs going forward. I typically put <code>mit.edu</code> at the top and a
few more from the <code>America</code> section.</p>
</blockquote>
</li>
<li>
<p>Install packages on the root file system.</p>
<pre tabindex="0"><code>pacstrap /mnt linux linux-firmware base base-devel grub efibootmgr vim git intel-ucode networkmanager
</code></pre><ul>
<li><code>linux</code>: linux kernel ( <a href="https://web.archive.org/web/20240228145207/https://www.archlinux.org/packages/core/x86_64/linux">https://www.archlinux.org/packages/core/x86_64/linux</a> ).</li>
<li><code>linux-firmware</code>: linux kernel ( <a href="https://web.archive.org/web/20240228145207/https://www.archlinux.org/packages/core/any/linux-firmware">https://www.archlinux.org/packages/core/any/linux-firmware</a> ).</li>
<li><code>base</code>: common packages for Linux ( <a href="https://web.archive.org/web/20240228145207/https://www.archlinux.org/groups/x86_64/base">https://www.archlinux.org/groups/x86_64/base</a> ).</li>
<li><code>base-devel</code>:common package for development in Linux ( <a href="https://web.archive.org/web/20240228145207/https://www.archlinux.org/groups/x86_64/base-devel">https://www.archlinux.org/groups/x86_64/base-devel</a> ).</li>
<li><code>grub</code>: (GRand Unified Bootloader) is a multi-boot loader.</li>
<li><code>vim</code>: text editor.</li>
<li><code>git</code>: version control system.</li>
<li><code>efibootmgr</code>: userspace application used to modify the Intel Extensible Firmware Interface (EFI) Boot Manager.</li>
<li><code>intel-ucode</code>: processor microcode; assumes Intel x86 processor.</li>
<li><code>networkmanager</code>: handles connecting to wireless and wired networks.</li>
</ul>
</li>
<li>
<p>Generate file system table (fstab) for mounting partitions.</p>
<pre tabindex="0"><code>genfstab -U /mnt &gt;&gt; /mnt/etc/fstab
</code></pre><ul>
<li><code>-u</code>: Use UUIDs for source identifiers.</li>
</ul>
</li>
</ol>
<h3 id="system-configuration">System Configuration</h3>
<p>The system needs some configuration steps completed in order to support the
language, timezone, and expected character encodings. To configure these aspects, do:</p>
<ol>
<li>
<p>Enter the system root via <code>arch-chroot</code>.</p>
<pre tabindex="0"><code>arch-chroot /mnt
</code></pre></li>
<li>
<p>Set your timezone.</p>
<pre tabindex="0"><code>ln -sf /usr/share/zoneinfo/America/Denver /etc/localtime
</code></pre></li>
<li>
<p>Set the Hardware Clock from the System Clock, and update the timestamps in /etc/adjtime.</p>
<pre tabindex="0"><code>hwclock --systohc
</code></pre></li>
<li>
<p>Uncomment <code>en_US.UTF-8 UTF-8</code> in <code>/etc/locale.gen</code>.</p>
<pre tabindex="0"><code>#en_SG.UTF-8 UTF-8
#en_SG ISO-8859-1
en_US.UTF-8 UTF-8
#en_US ISO-8859-1
#en_ZA.UTF-8 UTF-8
</code></pre><blockquote>
<p>Modify for your <a href="https://web.archive.org/web/20240228145207/https://wiki.archlinux.org/index.php/locale">locale</a>.</p>
</blockquote>
</li>
<li>
<p>Generate <a href="https://web.archive.org/web/20240228145207/https://wiki.archlinux.org/index.php/locale">locale</a>.</p>
<pre tabindex="0"><code>locale-gen
</code></pre></li>
<li>
<p>Set the <code>LANG</code> variable to the same locale in <code>/etc/locale.conf</code>.</p>
<pre tabindex="0"><code>echo &#34;LANG=en_US.UTF-8&#34; &gt;&gt; /etc/locale.conf
</code></pre></li>
<li>
<p>Set your <code>hostname</code>.</p>
<pre tabindex="0"><code>echo &#34;taco&#34; &gt;&gt; /etc/hostname
</code></pre></li>
</ol>
<h3 id="initial-ramdisk-configuration">Initial Ramdisk Configuration</h3>
<p>The initial ramdisk is a root file system that will be booted into memory. It aids in startup. This
section covers setup and generation of an mkinitcpio configuration for generating
<a href="https://web.archive.org/web/20240228145207/https://wiki.archlinux.org/index.php/Arch_boot_process#initramfs">initramfs</a>.</p>
<ol>
<li>
<p>Add <code>encrypt</code> to <code>HOOKS</code> in <code>/etc/mkinitcpio.conf</code> (order matters).</p>
<pre tabindex="0"><code>HOOKS=(base udev autodetect modconf block encrypt filesystems keyboard fsck)
</code></pre><p><code>HOOKS</code> are modules added to the initramfs image. Without <code>encrypt</code> and <code>lvm2</code>, systems won't
contain modules necessary to decrypt LUKs.</p>
</li>
<li>
<p>Move <code>keyboard</code> before <code>modconf</code> in <code>HOOKS</code>.</p>
<pre tabindex="0"><code>HOOKS=(base udev autodetect keyboard modconf block encrypt filesystems fsck)
</code></pre></li>
<li>
<p>Build initramfs with the <code>linux</code> preset.</p>
<pre tabindex="0"><code>mkinitcpio -p linux
</code></pre></li>
</ol>
<h3 id="grub-bootloader-setup">GRUB Bootloader Setup</h3>
<p>The bootloader will enable selection of and booting into Linux and Windows.
There are a variety of bootloaders out there, I prefer <code>grub</code> due to
familiarity. To setup <code>grub</code>:</p>
<ol>
<li>
<p>Determine the UUID of your root partition and EFI parition.</p>
<pre tabindex="0"><code>blkid
</code></pre>
<a href="https://web.archive.org/web/20240228145207/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/uuid.png" target="octetz-img">
<img src="https://web.archive.org/web/20240228145207im_/https://octetz.s3.us-east-2.amazonaws.com/linux-windows-install/uuid.png" width="600">
</a>
</li>
<li>
<p>Edit the GRUB boot loader configuration.</p>
<pre tabindex="0"><code>vim /etc/default/grub
</code></pre></li>
<li>
<p>Update the <code>GRUB_CMDLINE_LINUX</code> to match the format
<code>cryptdevice=UUID=${ROOT_UUID}:cryptroot root=/dev/mapper/cryptroot</code> where <code>${ROOT_UUID}</code> is the UUID
captured above.</p>
<pre tabindex="0"><code>GRUB_CMDLINE_LINUX=&#34;cryptdevice=UUID=4f7301bf-a44f-4b90-ad6d-5ec10a0c2f2a:cryptroot root=/dev/mapper/cryptroot&#34;
</code></pre></li>
<li>
<p>Add grub menu item for Windows 10 by editing <code>/etc/grub.d/40_custom</code>.</p>
<pre tabindex="0"><code>#!/bin/sh
exec tail -n +3 $0
# This file provides an easy way to add custom menu entries.  Simply type the
# menu entries you want to add after this comment.  Be careful not to change
# the &#39;exec tail&#39; line above.
if [ &#34;${grub_platform}&#34; == &#34;efi&#34; ]; then
  menuentry &#34;Windows 11&#34; {
    insmod part_gpt
    insmod fat
    insmod search_fs_uuid
    insmod chain
    # use:
    # after --set=root, add the EFI partition&#39;s UUID
    # this can be found with either:
    #
    # a. blkid
    # - or -
    # b. grub-probe --target=fs_uuid /boot/efi/EFI/VeraCrypt/DcsBoot.efi
    #
    search --fs-uuid --set=root $FS_UUID
    chainloader /EFI/VeraCrypt/DcsBoot.efi
  }
fi
</code></pre></li>
<li>
<p>Replace <code>$FS_UUID</code> with the EFI partition's UUID, found in step 1 of this
section. In this example:</p>
<pre tabindex="0"><code>search --fs-uuid --set=root 8E12-69DD
</code></pre></li>
<li>
<p>Install grub.</p>
<pre tabindex="0"><code>grub-install
</code></pre><blockquote>
<p>This assumes your efi is located in <code>/boot/efi</code>; additional flags are
available if you used an alternative location.</p>
</blockquote>
</li>
<li>
<p>Generate the grub configuration.</p>
<pre tabindex="0"><code>grub-mkconfig -o /boot/grub/grub.cfg
</code></pre></li>
</ol>
<h3 id="final-setup">Final Setup</h3>
<p>Lastly, you need to ensure your initial user is setup and a networking daemon is
good to go when you reboot. The final steps are:</p>
<ol>
<li>
<p>Set the root password.</p>
<pre tabindex="0"><code>passwd
</code></pre></li>
<li>
<p>Add a user.</p>
<pre tabindex="0"><code>useradd -m -G wheel josh
</code></pre><ul>
<li><code>-G</code> adds the user to a group.</li>
<li><code>-m</code> creates a home directory.</li>
</ul>
</li>
<li>
<p>Set the user's password.</p>
<pre tabindex="0"><code>passwd josh
</code></pre></li>
<li>
<p>Enter visudo.</p>
<pre tabindex="0"><code>visudo
</code></pre><p><code>visudo</code> edits the sudoers files at /etc/sudoers. It does this safely by acquiring a lock.</p>
</li>
<li>
<p>Uncomment the lines that allow users of group <code>wheel</code> to sudo.</p>
<pre tabindex="0"><code>## Uncomment to allow members of group wheel to execute any command
%wheel ALL=(ALL) ALL
</code></pre></li>
<li>
<p>Enable NetworkManager to ensure it starts after boot.</p>
<pre tabindex="0"><code>systemctl enable NetworkManager
</code></pre></li>
<li>
<p>Exit the <code>arch-chroot</code></p>
<pre tabindex="0"><code>exit
</code></pre></li>
<li>
<p>Unmount the partitions.</p>
<pre tabindex="0"><code>umount -R /mnt
</code></pre></li>
<li>
<p>Reboot.</p>
<pre tabindex="0"><code>reboot
</code></pre></li>
<li>
<p>Using grub, login to Arch Linux.</p>
</li>
<li>
<p>Use <code>nmtui-connect</code> to establish internet and begin installing packages.</p>
</li>
</ol>
<p>Congrats! You have officially booted your new Linux desktop.</p>
<h3 id="desktop-environment">Desktop Environment</h3>
<p>For my desktop environment, I install all packages and configuration using a
Makefile found at <a href="https://web.archive.org/web/20240228145207/https://github.com/octetz/linux-desktop">github.com/octetz/linux-desktop</a>.</p>
<p>I've detailed this process in my <a href="https://web.archive.org/web/20240228145207/https://octetz.com/docs/2020/2020-02-23-linux-desktop-configuration/">Linux Desktop
Configuration</a> post.</p>
</div>
<div class="content-toc">
<h3>Contents</h3>
<nav id="TableOfContents">
<ul>
<li><a href="index.html#laptop">Laptop</a></li>
<li><a href="index.html#installation-preparation">Installation Preparation</a>
<ul>
<li><a href="index.html#linux-install-media">Linux Install Media</a></li>
<li><a href="index.html#windows-install-media">Windows Install Media</a></li>
<li><a href="index.html#bios-setup">BIOS Setup</a></li>
<li><a href="index.html#disk-partition-layout">Disk (Partition) Layout</a></li>
</ul>
</li>
<li><a href="index.html#windows-install">Windows Install</a>
<ul>
<li><a href="index.html#disable-fast-boot">Disable Fast Boot</a></li>
<li><a href="index.html#encrypt-the-windows-volume">Encrypt the Windows Volume</a></li>
</ul>
</li>
<li><a href="index.html#linux-install">Linux Install</a>
<ul>
<li><a href="index.html#ssh-into-installer">SSH into Installer</a></li>
<li><a href="index.html#disk-partitioning">Disk Partitioning</a></li>
<li><a href="index.html#encrypting-and-configuring-the-root-partition">Encrypting and Configuring the Root Partition</a></li>
<li><a href="index.html#mounting-and-installing-linux">Mounting and Installing Linux</a></li>
<li><a href="index.html#system-configuration">System Configuration</a></li>
<li><a href="index.html#initial-ramdisk-configuration">Initial Ramdisk Configuration</a></li>
<li><a href="index.html#grub-bootloader-setup">GRUB Bootloader Setup</a></li>
<li><a href="index.html#final-setup">Final Setup</a></li>
<li><a href="index.html#desktop-environment">Desktop Environment</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</body>
</html>
<!--
     FILE ARCHIVED ON 14:52:07 Feb 28, 2024 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 03:17:11 Sep 10, 2024.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 0.405
  exclusion.robots: 0.014
  exclusion.robots.policy: 0.006
  esindex: 0.007
  cdx.remote: 23.953
  LoadShardBlock: 51.702 (3)
  PetaboxLoader3.datanode: 80.495 (4)
  load_resource: 159.765
  PetaboxLoader3.resolve: 92.241
-->
