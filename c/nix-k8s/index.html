<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta property="og:type" content="article"/>
<title>ardatasc.github.io</title>
<link rel="icon" href="../../favicon.png" type="image/x-icon">
<link rel="preconnect" href="https://fonts.googleapis.com/">
<link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
<link rel="preconnect" href="https://fonts.googleapis.com/">
<link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&display=swap.css" rel="stylesheet">
<link rel="preconnect" href="https://fonts.googleapis.com/">
<link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&amp;display=swap" rel="stylesheet">
<link rel="stylesheet" href="../../theme.min.7363202e6ba39c3b4caca8b218f6f6631256ed7a41cd2f8bf46550651b07cb31.css" integrity="">
</head>
<body>
  <div class="header">
  <div class="header-content">
  <div class="header-content-title">
  ardatasc
  </div>
  <div class="header-content-nav">
  <div class="header-content-nav-item">
  <a href="../../index.html">content</a>
  </div>
  <div class="header-content-nav-item">
  <a href="../../about.html">about</a>
  </div>
  </div>
  </div>
  </div>
<div class="content-container">
<div class="content"><h1 id="nix-hypervisor-kubernetes-and-containers">Nix: Hypervisor, Kubernetes, and Containers</h1>
<p><em>This guide accompanies my 2023 Kubecon talk, <a href="https://web.archive.org/web/20231208145439/https://youtu.be/U-mSWU4see0?si=j4FnoKxr8P8cE_SG">Nix, Kubernetes, and the Pursuit of Reproducibility</a>.</em></p>
<p><a href="https://web.archive.org/web/20231208145439/https://nixos.org/">Nix</a>, the language, packages, and operating system, is
seeing increased popularity with its promise of providing a highly-composable
way to create reproducible software. I've been intrigued by the Nix ecosystem
for some time as I often struggle to reproduce the exact configuration found on
my VMs and, at times, hypervisors. The reasoning for this struggle varies, but
often it's simply laziness of ensuring changes I've made on a host make it into
automation like Packer or Ansible. Trying to build my environment with Nix
seemed like a good way to rid myself of th is bad habit, while also learning a
new stack.</p>
<p>This guide will demonstrate the various configuration I've made in making this
transition to Nix(OS). I'll attempt to keep this guide pretty concise to the actual
steps taken, but see my Kubecon presentation for additional context (and some
jokes) around the use case:</p>
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
<iframe src="https://web.archive.org/web/20231208145439if_/https://www.youtube.com/embed/U-mSWU4see0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>
<h2 id="hypervisor">Hypervisor</h2>
<p>My hypervisors are run on an amalgamation of computers. These computers range
from decommissioned enterprise gear to old consumer hardware (often utilizing a
laptop or 2). For evidence of the &quot;jankyness&quot;, see below:</p>
<img class="center" src="https://web.archive.org/web/20231208145439im_/https://files.joshrosso.com/img/site/nix-k8s/homelab.jpeg" height="400px">
<p>Given that hardware may come and go, it's important I can provision the
hypervisor consistently. For setting up a hypervisor, the exercise largely
entails configuring networking and qemu/libvirt. Of course, this all comes after
the base-OS installation.</p>
<h3 id="os-install-via-iso">OS Install via ISO</h3>
<p>Since the hypervisor is installed on baremetal, we need to start by installing
the base NixOS operating system. Then we'll bring the custom configuration in.
I'll leave creating install media and installing the base OS to you. The Nix
community also has this <a href="https://web.archive.org/web/20231208145439/https://nixos.org/manual/nixos/stable/#ch-installation">documented in their
manuals</a>.</p>
<p>One convenience I've created is a filesystem provisioning script and a base
install script. These scripts can be run from a remote machine. When you boot
your machine from the ISO, <code>sshd</code> will already be enabled. To utilize ssh, run
<code>passwd</code> and set a password for <code>root</code>, then you can SSH in from any remote
machines. The shell scripts I run from the remote machines look as follows.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1"># inspired by https://github.com/mitchellh/nixos-config/blob/0547ecb427797c3fb4919cef692f1580398b99ec/Makefile#L51-L77</span>
</span></span><span class="line"><span class="cl">ssh root@<span class="si">${</span><span class="nv">NIXADDR</span><span class="si">}</span> <span class="s2">&#34; \
</span></span></span><span class="line"><span class="cl"><span class="s2">    umount -R /mnt; \
</span></span></span><span class="line"><span class="cl"><span class="s2">    wipefs -a /dev/sda; \
</span></span></span><span class="line"><span class="cl"><span class="s2">    parted -s /dev/sda -- mklabel gpt; \
</span></span></span><span class="line"><span class="cl"><span class="s2">    parted /dev/sda -- mkpart primary 512MiB 100\%; \
</span></span></span><span class="line"><span class="cl"><span class="s2">    parted /dev/sda -- mkpart ESP fat32 1MiB 512MiB; \
</span></span></span><span class="line"><span class="cl"><span class="s2">    parted /dev/sda -- set 2 esp on; \
</span></span></span><span class="line"><span class="cl"><span class="s2">    sleep 1; \
</span></span></span><span class="line"><span class="cl"><span class="s2">    mkfs.ext4 -L nixos /dev/sda1; \
</span></span></span><span class="line"><span class="cl"><span class="s2">    mkfs.fat -F 32 -n boot /dev/sda2; \
</span></span></span><span class="line"><span class="cl"><span class="s2">    sleep 1; \
</span></span></span><span class="line"><span class="cl"><span class="s2">    mount /dev/disk/by-label/nixos /mnt; \
</span></span></span><span class="line"><span class="cl"><span class="s2">    mkdir -p /mnt/boot; \
</span></span></span><span class="line"><span class="cl"><span class="s2">    mount /dev/disk/by-label/boot /mnt/boot; \
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;</span>
</span></span></code></pre></div><p>The above sets up system partitions and uses any remaining space for root. For
simplicity I've left volume encryption out of this guide, however you may want to
consider setting this up. The next script performs the base install:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">ssh root@<span class="si">${</span><span class="nv">NIXADDR</span><span class="si">}</span> <span class="s2">&#34; \
</span></span></span><span class="line"><span class="cl"><span class="s2">    nixos-generate-config --root /mnt; \
</span></span></span><span class="line"><span class="cl"><span class="s2">    sed --in-place &#39;/system\.stateVersion = .*/a \
</span></span></span><span class="line"><span class="cl"><span class="s2">      nix.extraOptions = \&#34;experimental-features = nix-command flakes\&#34;;\n \
</span></span></span><span class="line"><span class="cl"><span class="s2">      services.openssh.enable = true;\n \
</span></span></span><span class="line"><span class="cl"><span class="s2">      services.openssh.passwordAuthentication = true;\n \
</span></span></span><span class="line"><span class="cl"><span class="s2">      services.openssh.permitRootLogin = \&#34;yes\&#34;;\n \
</span></span></span><span class="line"><span class="cl"><span class="s2">      users.users.root.initialPassword = \&#34;root\&#34;;\n \
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#39; /mnt/etc/nixos/configuration.nix; \
</span></span></span><span class="line"><span class="cl"><span class="s2">    nixos-install --no-root-passwd; \
</span></span></span><span class="line"><span class="cl"><span class="s2"> &#34;</span>
</span></span></code></pre></div><p>Assuming the above scripts are called <code>setup-filesystem.sh</code> and
<code>install-nix.sh</code> respectively, I can install against the hypervisor by running
the following from a remote client.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">NIXADDR</span><span class="o">=</span>192.168.33.23 ./setup-filesystem.sh
</span></span><span class="line"><span class="cl"><span class="nv">NIXADDR</span><span class="o">=</span>192.168.33.23 ./install-nix.sh
</span></span></code></pre></div><p>Now we have NixOS installed and layed out on a simple partition scheme. From
here we can reboot and start configuring the system.</p>
<h3 id="networking-and-software">Networking and Software</h3>
<p>For my hypervisors, the networking configuration involves a bridge interface
that acts a virtual switch for the VMs. The bridge interface is connected to a
physical nic's interface. In this model, VMs get a routable (LAN) IP address
from DHCP. For details on hypervisor networking, you may find my post <a href="https://web.archive.org/web/20231208145439/https://joshrosso.com/c/vm-networks">VM
Networking</a> interesting. Visually, you can
think of the networking setup as follows:</p>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="100%" viewbox="-0.5 -0.5 831 381" content="<mxfile host=&quot;Electron&quot; modified=&quot;2023-11-12T15:14:23.640Z&quot; agent=&quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.2.8 Chrome/116.0.5845.228 Electron/26.3.0 Safari/537.36&quot; etag=&quot;RJzxkWrmx47lUwb6EJPX&quot; version=&quot;21.2.8&quot; type=&quot;device&quot;><diagram name=&quot;Page-1&quot; id=&quot;Pce8RPPKagThAF2YylDD&quot;>1Vlbb9owGP01SNvDqthOCDwW2o5Jq9aJh61PlUncxFuIkWMu2a+fTWwSN+FSAQ1ICOLP1xyfc3yhg4bT1VeOZ/EjC0nSgU646qC7DoTARa78UZFcRxzHKSIRp6GOlYEx/UdMQR2d05BkVkHBWCLozA4GLE1JIKwY5pwt7WKvLLF7neGI1ALjACf16C8airiI9jynjI8IjWLTMzDvN8WmsA5kMQ7ZshJC9x005IyJ4mm6GpJEoWdwKeo9bMndDIyTVBxSYTSYDygeD90J8B5efoweZz9fvuhWFjiZ6xfuwG4i2xtM5EOkHuJ8RviCZoybLNnHJldW7qBb9YGObiwTuUGPs3kaEjUAWWqwjKkg4xkOVO5SEka1LqaJTAH5uCBcUIn8bUKjVMYEm607WA9Q5pHV1jcHGzwlEwmbEsFzWURXgGZONAkh0ullOaN+X8fiymwiM81YsyjatF0CLR801u/A3a1BRULJO51kXMQsYilO7svowAazLPOdKaDWEP4hQuRaRHgumA1w0afqaDeQclxszgOyY/xQSxHziIgd5VDzxHCSYEEX9jhODjLcT26aCsJfFSP3cJuI2KnN2bvofQoiI3jjWVT2nDqVAWigsnsuJqMayCkRS8b/qooluk6Aedg+gOANfN0G+FyvDh88F3zdNoxAosXz36q+pJNOPuvm1om7lZXKdeqEBuIdaCCwTQPx9hvIRO5aImJzfbeTTHj7RoKQrQMX1nXggQYdnM1G/P1QLygXc5ys91ZBTNO9SF/sfgS+2Y/4dfRl8KYB/423n3wC+le+I+kdaChem4bSO+WOJM1Q+0bi2VRGDQtqv/eB66nRx0mNBF6okbg9cHlGYpaNq3USYO4ZLtpKwAFH9+vyki6w2dy+lxxwgHy3lxyJ89m8xHcvcFMC2jkeraionI5k6rmSU56NVMIcjS7gSAXQVfhW/cLgyn2r51/aHqjXimqMAoDF/1IOWxRA0vBWXdTLZMpSUkQeqHrldX6Is3g9rlMv8/5VyGX7wZgaReBAZEXf8kuV3axJ2ZKKIK6oiJYqOkY1DXNynIRc/5CLTdhwsdk9l4pg/ZrmI9eeysrj3PhmIWpefKzp2KenU0qof6CEwLHXeOuq8rVwXikwY3KhyCotP6lAhVWea29p9M1uyYqixZIjm6EdIdj+fsESrETpLKaKyxvZSu4IPEnUZeK3J/n1aUFV+G40fPp8+RLugzf7xzMKWCbL/02LiSv/fkb3/wE=</diagram></mxfile>" style="background-color: rgb(255, 255, 255);"><defs/><g><rect x="0" y="30" width="790" height="350" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignobject pointer-events="none" width="100%" height="100%" requiredfeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe center; width: 788px; height: 1px; padding-top: 37px; margin-left: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><b>hypervisor</b> :: 1</div></div></div></foreignobject><text x="395" y="49" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">hypervisor :: 1</text></switch></g><path d="M 87.5 340 L 87.5 360 L 87.5 340 L 87.5 353.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 87.5 358.88 L 84 351.88 L 87.5 353.63 L 91 351.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><rect x="32.5" y="300" width="110" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignobject pointer-events="none" width="100%" height="100%" requiredfeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 108px; height: 1px; padding-top: 320px; margin-left: 34px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><b>interface</b> :: eth0</div></div></div></foreignobject><text x="88" y="324" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">interface :: eth0</text></switch></g><rect x="15" y="360" width="145" height="20" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignobject pointer-events="none" width="100%" height="100%" requiredfeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 143px; height: 1px; padding-top: 370px; margin-left: 16px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">network interface card</div></div></div></foreignobject><text x="88" y="374" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">network interface card</text></switch></g><path d="M 392.5 260 L 392.5 280 L 87.5 280 L 87.5 293.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 87.5 298.88 L 84 291.88 L 87.5 293.63 L 91 291.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><rect x="135" y="220" width="515" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignobject pointer-events="none" width="100%" height="100%" requiredfeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 513px; height: 1px; padding-top: 240px; margin-left: 136px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><b>bridge interface</b> :: br0</div></div></div></foreignobject><text x="393" y="244" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">bridge interface :: br0</text></switch></g><rect x="20" y="70" width="227.5" height="110" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignobject pointer-events="none" width="100%" height="100%" requiredfeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe center; width: 226px; height: 1px; padding-top: 77px; margin-left: 21px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><b>virtual machine</b> :: 1</div></div></div></foreignobject><text x="134" y="89" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">virtual machine :: 1</text></switch></g><path d="M 199 180 L 199 200 L 392.5 200 L 392.5 213.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 392.5 218.88 L 389 211.88 L 392.5 213.63 L 396 211.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><rect x="150" y="160" width="98" height="20" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignobject pointer-events="none" width="100%" height="100%" requiredfeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 96px; height: 1px; padding-top: 170px; margin-left: 151px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><b>interface</b> :: ens3</div></div></div></foreignobject><text x="199" y="174" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">interface :: ens3</text></switch></g><rect x="281" y="70" width="227.5" height="110" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignobject pointer-events="none" width="100%" height="100%" requiredfeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe center; width: 226px; height: 1px; padding-top: 77px; margin-left: 282px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><b>virtual machine</b> :: 2</div></div></div></foreignobject><text x="395" y="89" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">virtual machine :: 2</text></switch></g><path d="M 460 180 L 460 200 L 392.5 200 L 392.5 213.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 392.5 218.88 L 389 211.88 L 392.5 213.63 L 396 211.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><rect x="411" y="160" width="98" height="20" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignobject pointer-events="none" width="100%" height="100%" requiredfeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 96px; height: 1px; padding-top: 170px; margin-left: 412px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><b>interface</b> :: ens3</div></div></div></foreignobject><text x="460" y="174" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">interface :: ens3</text></switch></g><rect x="540" y="70" width="227.5" height="110" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignobject pointer-events="none" width="100%" height="100%" requiredfeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe center; width: 226px; height: 1px; padding-top: 77px; margin-left: 541px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><b>virtual machine</b> :: 3</div></div></div></foreignobject><text x="654" y="89" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">virtual machine :: 3</text></switch></g><path d="M 719 180 L 719 200 L 392.5 200 L 392.5 213.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 392.5 218.88 L 389 211.88 L 392.5 213.63 L 396 211.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><rect x="670" y="160" width="98" height="20" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignobject pointer-events="none" width="100%" height="100%" requiredfeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 96px; height: 1px; padding-top: 170px; margin-left: 671px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><b>interface</b> :: ens3</div></div></div></foreignobject><text x="719" y="174" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">interface :: ens3</text></switch></g><path d="M 707.5 300 L 707.5 240 L 650 240" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="stroke"/><rect x="647.5" y="300" width="120" height="60" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" stroke-dasharray="3 3" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignobject pointer-events="none" width="100%" height="100%" requiredfeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 330px; margin-left: 649px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><i>acts as a virtual switch</i></div></div></div></foreignobject><text x="708" y="334" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">acts as a virtual sw...</text></switch></g><path d="M 710 45 L 654 45 L 654 70" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="stroke"/><rect x="710" y="0" width="120" height="60" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" stroke-dasharray="3 3" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignobject pointer-events="none" width="100%" height="100%" requiredfeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 30px; margin-left: 711px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><i>each vm has a routable IP (via DHCP)</i></div></div></div></foreignobject><text x="770" y="34" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">each vm has a routab...</text></switch></g></g><switch><g requiredfeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/><a transform="translate(0,-5)" xlink:href="https://www.drawio.com/doc/faq/svg-export-text-problems" target="_blank"><text text-anchor="middle" font-size="10px" x="50%" y="100%">Text is not SVG - cannot display</text></a></switch></svg>
<p>After installing the base system, a file named <code>/etc/nixos/configuration.nix</code>
was created. This is the file to update with networking and software details. I
like to keep this file as is, but add an extra one to <code>/etc/nixos/extra.nix</code>. I
went ahead and added a <code># TODO(you)</code> comment to each area you're likely to need
to update.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl"><span class="p">{</span> <span class="n">config</span><span class="o">,</span> <span class="n">pkgs</span><span class="o">,</span> <span class="o">...</span> <span class="p">}:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># TODO(you): switch this for kvm-amd if using AMD instead.</span>
</span></span><span class="line"><span class="cl">  <span class="n">boot</span><span class="o">.</span><span class="n">kernelModules</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&#34;kvm-intel&#34;</span> <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># disable dhcpcd since we&#39;ll use systemd-networkd</span>
</span></span><span class="line"><span class="cl">  <span class="n">networking</span><span class="o">.</span><span class="n">useDHCP</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">mkDefault</span> <span class="no">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">systemd</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">netdevs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="c1"># Create the bridge interface</span>
</span></span><span class="line"><span class="cl">       <span class="s2">&#34;20-br0&#34;</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">netdevConfig</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">           <span class="n">Kind</span> <span class="o">=</span> <span class="s2">&#34;bridge&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">           <span class="n">Name</span> <span class="o">=</span> <span class="s2">&#34;br0&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="p">};</span>
</span></span><span class="line"><span class="cl">       <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">networks</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># TODO(you): update `30-enp2s0` to your NIC&#39;s interface (run `ifconfig`)</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># Connect the bridge ports to the bridge</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;30-enp2s0&#34;</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># TODO(you): update `enp2s0` to your NIC&#39;s interface (run `ifconfig`)</span>
</span></span><span class="line"><span class="cl">        <span class="n">matchConfig</span><span class="o">.</span><span class="n">Name</span> <span class="o">=</span> <span class="s2">&#34;enp2s0&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">networkConfig</span><span class="o">.</span><span class="n">Bridge</span> <span class="o">=</span> <span class="s2">&#34;br0&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">linkConfig</span><span class="o">.</span><span class="n">RequiredForOnline</span> <span class="o">=</span> <span class="s2">&#34;enslaved&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;40-br0-dhcp&#34;</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    	<span class="n">matchConfig</span><span class="o">.</span><span class="n">Name</span> <span class="o">=</span> <span class="s2">&#34;br0&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">networkConfig</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DHCP</span> <span class="o">=</span> <span class="s2">&#34;ipv4&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">virtualisation</span><span class="o">.</span><span class="n">libvirtd</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">virtualisation</span><span class="o">.</span><span class="n">libvirtd</span><span class="o">.</span><span class="n">allowedBridges</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;br0&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># required by libvirtd</span>
</span></span><span class="line"><span class="cl">  <span class="n">security</span><span class="o">.</span><span class="n">polkit</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">environment</span><span class="o">.</span><span class="n">systemPackages</span> <span class="o">=</span> <span class="k">with</span> <span class="n">pkgs</span><span class="p">;</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">neovim</span>
</span></span><span class="line"><span class="cl">    <span class="n">wget</span>
</span></span><span class="line"><span class="cl">    <span class="n">jq</span>
</span></span><span class="line"><span class="cl">    <span class="n">curl</span>
</span></span><span class="line"><span class="cl">    <span class="n">virt-manager</span>
</span></span><span class="line"><span class="cl">    <span class="n">htop</span>
</span></span><span class="line"><span class="cl">    <span class="n">prometheus</span>
</span></span><span class="line"><span class="cl">    <span class="n">prometheus-node-exporter</span>
</span></span><span class="line"><span class="cl">    <span class="n">prometheus-process-exporter</span>
</span></span><span class="line"><span class="cl">  <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">environment</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">EDITOR</span> <span class="o">=</span> <span class="s2">&#34;nvim&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Enable the OpenSSH daemon.</span>
</span></span><span class="line"><span class="cl">  <span class="n">services</span><span class="o">.</span><span class="n">tailscale</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">services</span><span class="o">.</span><span class="n">openssh</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">services</span><span class="o">.</span><span class="n">openssh</span><span class="o">.</span><span class="n">passwordAuthentication</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">services</span><span class="o">.</span><span class="n">openssh</span><span class="o">.</span><span class="n">permitRootLogin</span> <span class="o">=</span> <span class="s2">&#34;yes&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">services</span><span class="o">.</span><span class="n">openssh</span><span class="o">.</span><span class="n">extraConfig</span> <span class="o">=</span> <span class="s1">&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">AllowStreamLocalForwarding yes
</span></span></span><span class="line"><span class="cl"><span class="s1">AllowTcpForwarding yes
</span></span></span><span class="line"><span class="cl"><span class="s1">  &#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># note this setting, in cause you wish to be more restrictive at the OS-level.</span>
</span></span><span class="line"><span class="cl">  <span class="n">networking</span><span class="o">.</span><span class="n">firewall</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="no">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Reading the configuration above tells most of the story, but lets call out a few things.</p>
<ol>
<li>We are setting <code>dhcpcd</code> to false in favor of using <code>systemd-networkd</code>. Otherwise
<a href="https://web.archive.org/web/20231208145439/https://search.nixos.org/options?channel=23.05&amp;show=networking.dhcpcd.enable&amp;from=0&amp;size=50&amp;sort=relevance&amp;type=packages&amp;query=networking.dhcp">it would be defaulted to
true</a>.</li>
<li>Enabling <code>virualization.libvirt</code> handles much of the plumbing and ensures
associated packages are installed.</li>
<li>If your networking does not work on boot, use <code>journalctl -u systemd-networkd</code> to view the logs.</li>
<li>Nix performs a hardware scan, which imports the majority of required
hardware-specific configuration, however we do enable KVM above (change this
setting if using AMD).</li>
</ol>
<p>To use the <code>extra.nix</code> file in our system build, we need to import it to <code>/etc/nixos/configuration</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl"><span class="p">{</span> <span class="n">config</span><span class="o">,</span> <span class="n">pkgs</span><span class="o">,</span> <span class="o">...</span> <span class="p">}:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">imports</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span> <span class="c1"># Include the results of the hardware scan.</span>
</span></span><span class="line"><span class="cl">      <span class="sr">./hardware-configuration.nix</span>
</span></span><span class="line"><span class="cl">      <span class="sr">./extra.nix</span>
</span></span><span class="line"><span class="cl">    <span class="p">];</span>
</span></span></code></pre></div><p>Now we're set to re-build the operating system. Normally these changes can
happen in place, but since we're configuring network interfaces, I recommend a
full reboot.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">nixos-rebuild switch
</span></span></code></pre></div><h2 id="vm">VM</h2>
<p>Now lets create VM images capable of running Kubernetes. There are a variety of
ways to approach this, one of which is to use <a href="https://web.archive.org/web/20231208145439/https://search.nixos.org/options?channel=23.05&amp;from=0&amp;size=50&amp;sort=relevance&amp;type=packages&amp;query=kubernetes">the Kubernetes modules provided
by
NixOS</a>.
However, in my lab, I prefer setting up the base packages, unit files, and then
leveraging <code>kubeadm</code> to manage the Kubernetes bits. Admittedly, mutating the
system with <code>kubeadm</code> is a little impure as far as Nix is concerned, but I'm ok
with that. So, for the VMs, the following things are going to be setup.</p>
<ol>
<li><code>kubeadm</code>.</li>
<li>Kubernetes bits (e.g. <code>kubelet</code>, <code>kubectl</code>).</li>
<li>A container runtime (<code>containerd</code>).</li>
</ol>
<p>These have some dependencies we need to consider as well, but for now, let's
examine a <code>configuration.nix</code> file that may encompass the above.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl"><span class="p">{</span> <span class="n">config</span><span class="o">,</span> <span class="n">pkgs</span><span class="o">,</span> <span class="o">...</span> <span class="p">}:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># text that shows up when you ssh in. Makes for an easy parameter to change</span>
</span></span><span class="line"><span class="cl">  <span class="n">when</span> <span class="n">testing</span> <span class="n">builds</span> <span class="n">too</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  <span class="n">users</span><span class="o">.</span><span class="n">motd</span> <span class="o">=</span> <span class="s2">&#34;Hello Kubecon Chicago!!!&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">networking</span><span class="o">.</span><span class="n">hostName</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">system</span><span class="o">.</span><span class="n">stateVersion</span> <span class="o">=</span> <span class="s2">&#34;23.05&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">virtualisation</span><span class="o">.</span><span class="n">containerd</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">configFile</span> <span class="o">=</span> <span class="sr">./containerd-config.toml</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># kernel modules and settings required by Kubernetes</span>
</span></span><span class="line"><span class="cl">  <span class="n">boot</span><span class="o">.</span><span class="n">kernelModules</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&#34;overlay&#34;</span> <span class="s2">&#34;br_netfilter&#34;</span> <span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">boot</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">sysctl</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;net.bridge.bridge-nf-call-iptables&#34;</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;net.bridge.bridge-nf-call-ip6tables&#34;</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;net.ipv4.ip_forward&#34;</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># List packages installed in system profile. To search, run:</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># $ nix search wget</span>
</span></span><span class="line"><span class="cl">  <span class="n">environment</span><span class="o">.</span><span class="n">systemPackages</span> <span class="o">=</span> <span class="k">with</span> <span class="n">pkgs</span><span class="p">;</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">neovim</span>
</span></span><span class="line"><span class="cl">    <span class="n">wget</span>
</span></span><span class="line"><span class="cl">    <span class="n">ripgrep</span>
</span></span><span class="line"><span class="cl">    <span class="n">prometheus-node-exporter</span>
</span></span><span class="line"><span class="cl">    <span class="n">prometheus-process-exporter</span>
</span></span><span class="line"><span class="cl">    <span class="n">kubernetes</span>
</span></span><span class="line"><span class="cl">    <span class="n">containerd</span>
</span></span><span class="line"><span class="cl">    <span class="n">cri-tools</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ebtables</span>
</span></span><span class="line"><span class="cl">    <span class="n">ethtool</span>
</span></span><span class="line"><span class="cl">    <span class="n">socat</span>
</span></span><span class="line"><span class="cl">    <span class="n">iptables</span>
</span></span><span class="line"><span class="cl">    <span class="n">conntrack-tools</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="kn">import</span> <span class="sr">./hostname.nix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">systemd</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">kubelet</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">description</span> <span class="o">=</span> <span class="s2">&#34;kubelet&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">serviceConfig</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">ExecStart</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">${</span><span class="n">pkgs</span><span class="o">.</span><span class="n">kubernetes</span><span class="si">}</span><span class="s2">/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">Environment</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf</span><span class="se">\&#34;</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml</span><span class="se">\&#34;</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;PATH=/run/wrappers/bin:/root/.nix-profile/bin:/etc/profiles/per-user/root/bin:/nix/var/nix/profiles/default/bin:/run/current-system/sw/bin&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">EnvironmentFile</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;-/var/lib/kubelet/kubeadm-flags.env&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;-/etc/default/kubelet&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">Restart</span> <span class="o">=</span> <span class="s2">&#34;always&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">StartLimitInterval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">RestartSec</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">wantedBy</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&#34;network-online.target&#34;</span> <span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">after</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&#34;network-online.target&#34;</span> <span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">systemd</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">hostname-init</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">description</span> <span class="o">=</span> <span class="s2">&#34;set the hostname to the IP&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">serviceConfig</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">ExecStart</span> <span class="o">=</span> <span class="s2">&#34;/run/current-system/sw/bin/hostname-init&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">wantedBy</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&#34;network-online.target&#34;</span> <span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">after</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&#34;network-online.target&#34;</span> <span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">environment</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">EDITOR</span> <span class="o">=</span> <span class="s2">&#34;nvim&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Enable the OpenSSH daemon.</span>
</span></span><span class="line"><span class="cl">  <span class="n">users</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">initialPassword</span> <span class="o">=</span> <span class="s2">&#34;root&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">services</span><span class="o">.</span><span class="n">openssh</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">services</span><span class="o">.</span><span class="n">openssh</span><span class="o">.</span><span class="n">passwordAuthentication</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">services</span><span class="o">.</span><span class="n">openssh</span><span class="o">.</span><span class="n">permitRootLogin</span> <span class="o">=</span> <span class="s2">&#34;yes&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">networking</span><span class="o">.</span><span class="n">firewall</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="no">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The above references some external files we'll examine now. The first is the
<code>containerd-config.toml</code>. This is needed as there is some specific
configuration required <a href="https://web.archive.org/web/20231208145439/https://kubernetes.io/docs/setup/production-environment/container-runtimes/#cgroup-drivers">per the Kubernetes
docs, namely the cgroup driver</a>.
The config file is really long, so in this guide I'll show pulling from a link:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">wget https://raw.githubusercontent.com/joshrosso/hypernix/main/vm-images/containerd-config.toml
</span></span></code></pre></div><p>The last extra config is <code>hostname.nix</code>. This is...less than ideal...but works
really well for me until I have a more capable DHCP setup. The idea is that
when a host boots the unit file resolves the DHCP-provided IP address and
generates a hostname. It then reboots the system and continues forward. This
approach (hack?) assumes the IP address will never change for the life of the
VM. The <code>nix</code> definition is:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl"><span class="k">with</span> <span class="kn">import</span> <span class="sr">&lt;nixpkgs&gt;</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">writeShellApplication</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">name</span> <span class="o">=</span> <span class="s2">&#34;hostname-init&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">	#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="s1">	SN=&#34;hostname-init&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">	# do nothing if /etc/hostname exists
</span></span></span><span class="line"><span class="cl"><span class="s1">	if [ -f &#34;/etc/hostname&#34; ]; then
</span></span></span><span class="line"><span class="cl"><span class="s1">		  echo &#34;</span><span class="se">&#39;&#39;$</span><span class="s1">{SN}: /etc/hostname exists; noop&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">		    exit
</span></span></span><span class="line"><span class="cl"><span class="s1">	fi
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">	SN=&#34;hostname-init&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">	echo &#34;</span><span class="se">&#39;&#39;$</span><span class="s1">{SN}: creating hostname&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">	# set hostname
</span></span></span><span class="line"><span class="cl"><span class="s1">	/run/current-system/sw/bin/ip -o -4 addr show | /run/current-system/sw/bin/awk &#39;!/ lo | docker[0-9]* /{ sub(/\/.*/, &#34;&#34;, $4); gsub(/\./, &#34;-&#34;, $4); print $4 }&#39; &gt; /etc/hostname
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">	if [ -f &#34;/etc/hostname&#34; ]; then
</span></span></span><span class="line"><span class="cl"><span class="s1">          /run/current-system/sw/bin/reboot
</span></span></span><span class="line"><span class="cl"><span class="s1">	fi
</span></span></span><span class="line"><span class="cl"><span class="s1">	&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>If you use the above and it gives you problems, use <code>journalctl -u hostname-init</code> to see the logs.</p>
<p>The above expresses a base configuration that could be used in a variety of
image formats. Since our hypervisor stack is built on KVM/qemu/libvirt, we'll
plan to use <code>qcow2</code> as the format. The
<a href="https://web.archive.org/web/20231208145439/https://github.com/nix-community/nixos-generators">nixos-generators</a> project
is where I went to get details on how to build for a variety of outputs. I've
since translated some things into <a href="https://web.archive.org/web/20231208145439/https://github.com/joshrosso/hypernix/tree/main/vm-images">this
repo</a>, which if
cloned down, you can fun the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">nix-build ./nixos-generate.nix <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --argstr formatConfig /root/hypernix/vm-images/formats/qcow.nix <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -I nixos-config<span class="o">=</span>configuration.nix <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --no-out-link <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -A config.system.build.qcow
</span></span></code></pre></div><p>However, rather than using mine, you may wish to see if you can get the
<code>nixos-generators</code> project to work since it's actually maintained. Once the
above command builds, you'll see an output in the <code>/nix/store</code>, as seen below.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@nixos:~/hypernix/vm-images<span class="o">]</span> ls /nix/store/aa494ixhf52l295c7isdkylvr135j84q-nixos-disk-image
</span></span><span class="line"><span class="cl">nixos.qcow2
</span></span></code></pre></div><p>I tend to move these base images into
<code>/var/lib/libvirt/images/{SOME_DIRECTORY}</code>. Although the exact location is
entirely up to you.</p>
<p>With the base image in place, it's a matter of standing up virtual machines. I
control this through Terraform, but that's a bit too long for this exercise.
Instead, here's a script that will spawn 3 VMs based on the image generated
above.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># TODO(you): change this to where you move your image to.</span>
</span></span><span class="line"><span class="cl"><span class="nv">PATH_IMG</span><span class="o">=</span>/var/lib/libvirt/images/
</span></span><span class="line"><span class="cl"><span class="nv">NAME</span><span class="o">=</span>k8s_base
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> i in <span class="o">{</span>1..3<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl">	cp -v <span class="si">${</span><span class="nv">PATH_IMG</span><span class="si">}</span>/<span class="si">${</span><span class="nv">NAME</span><span class="si">}</span>.qcow2 <span class="si">${</span><span class="nv">PATH_IMG</span><span class="si">}</span>/<span class="si">${</span><span class="nv">NAME</span><span class="si">}</span>-<span class="si">${</span><span class="nv">i</span><span class="si">}</span>.qcow2
</span></span><span class="line"><span class="cl">	virt-install <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	  --name kubecon_<span class="nv">$i</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	  --ram <span class="m">6000</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	  --vcpus <span class="m">2</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	  --os-variant generic <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	  --console pty,target_type<span class="o">=</span>serial <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	  --bridge<span class="o">=</span>br0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	  --graphics<span class="o">=</span>vnc,password<span class="o">=</span>foobar,port<span class="o">=</span>592<span class="si">${</span><span class="nv">i</span><span class="si">}</span>,listen<span class="o">=</span>0.0.0.0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	  --disk<span class="o">=</span><span class="si">${</span><span class="nv">PATH_IMG</span><span class="si">}</span>/<span class="si">${</span><span class="nv">NAME</span><span class="si">}</span>-<span class="si">${</span><span class="nv">i</span><span class="si">}</span>.qcow2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	  --import <span class="p">&amp;</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></div><p>Once the VMs are up, determine their IPs, SSH into them, and run <code>kubeadm init</code>
and <code>kubeadm join</code> to create your multi-node cluster.</p>
<h2 id="containers">Containers</h2>
<p>Containers will be run in the cluster via a Pod. Nix can be used to create
OCI-compliant container images, which then run via a container runtime such as
<code>containerd</code>. As far as I know, <code>pkgs.dockerTools</code> is the most ubiquitous was
to produce images with Nix. It has a bunch of mapping that relate to what you'd
expect in a Dockerfile, and many more benefits such as the ability to ensure
each <code>/nix/store</code> asset built is put in its own layer. Don't let the
<strong>docker</strong> part of the tool name throw you off. The outputted image will run
with any container runtime that supports OCI-based images (which should be
most/all of them).</p>
<p>Below is an example of an image building <code>nginx</code>, this is largely copied from
the <a href="https://web.archive.org/web/20231208145439/https://github.com/NixOS/nixpkgs/blob/master/pkgs/build-support/docker/examples.nix">upstream
examples</a>.
You can put the example in any directory and name it <code>nginx-container.nix</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl"><span class="p">{</span> <span class="n">pkgs</span> <span class="o">?</span> <span class="kn">import</span> <span class="sr">&lt;nixpkgs&gt;</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">,</span> <span class="n">pkgsLinux</span> <span class="o">?</span> <span class="kn">import</span> <span class="sr">&lt;nixpkgs&gt;</span> <span class="p">{</span> <span class="n">system</span> <span class="o">=</span> <span class="s2">&#34;x86_64-linux&#34;</span><span class="p">;</span> <span class="p">}</span> <span class="p">}:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">let</span>
</span></span><span class="line"><span class="cl">  <span class="n">conf</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">nginxWebRoot</span> <span class="o">=</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">writeTextDir</span> <span class="s2">&#34;index.html&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;  &lt;html&gt;&lt;body&gt;&lt;center&gt;&lt;marquee&gt;&lt;h1&gt;all ur PODZ is belong to ME&lt;/h1&gt;&lt;/marquee&gt; &lt;img src=</span><span class="se">\&#34;</span><span class="s2">https://m.media-amazon.com/images/M/MV5BYjBlODg3ZTgtN2ViNS00MDlmLWIyMTctZmQ2NWYwMzE2N2RmXkEyXkFqcGdeQVRoaXJkUGFydHlJbmdlc3Rpb25Xb3JrZmxvdw@@._V1_.jpg</span><span class="se">\&#34;</span><span class="s2"> width=</span><span class="se">\&#34;</span><span class="s2">100%</span><span class="se">\&#34;</span><span class="s2">&gt;&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">nginxPort</span> <span class="o">=</span> <span class="s2">&#34;80&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">nginxConf</span> <span class="o">=</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">writeText</span> <span class="s2">&#34;nginx.conf&#34;</span> <span class="s1">&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">      user nobody nobody;
</span></span></span><span class="line"><span class="cl"><span class="s1">      daemon off;
</span></span></span><span class="line"><span class="cl"><span class="s1">      error_log /dev/stdout info;
</span></span></span><span class="line"><span class="cl"><span class="s1">      pid /dev/null;
</span></span></span><span class="line"><span class="cl"><span class="s1">      events {}
</span></span></span><span class="line"><span class="cl"><span class="s1">      http {
</span></span></span><span class="line"><span class="cl"><span class="s1">        access_log /dev/stdout;
</span></span></span><span class="line"><span class="cl"><span class="s1">        server {
</span></span></span><span class="line"><span class="cl"><span class="s1">          listen </span><span class="si">${</span><span class="n">conf</span><span class="o">.</span><span class="n">nginxPort</span><span class="si">}</span><span class="s1">;
</span></span></span><span class="line"><span class="cl"><span class="s1">          index index.html;
</span></span></span><span class="line"><span class="cl"><span class="s1">          location / {
</span></span></span><span class="line"><span class="cl"><span class="s1">            root </span><span class="si">${</span><span class="n">conf</span><span class="o">.</span><span class="n">nginxWebRoot</span><span class="si">}</span><span class="s1">;
</span></span></span><span class="line"><span class="cl"><span class="s1">          }
</span></span></span><span class="line"><span class="cl"><span class="s1">        }
</span></span></span><span class="line"><span class="cl"><span class="s1">      }
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">in</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">dockerTools</span><span class="o">.</span><span class="n">buildLayeredImage</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">name</span> <span class="o">=</span> <span class="s2">&#34;joshrosso/kubecon&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">tag</span> <span class="o">=</span> <span class="s2">&#34;1.4&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">contents</span> <span class="o">=</span> <span class="p">[</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">fakeNss</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">nginx</span> <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">extraCommands</span> <span class="o">=</span> <span class="s1">&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    mkdir -p tmp/nginx_client_body
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    # nginx still tries to read this directory even if error_log
</span></span></span><span class="line"><span class="cl"><span class="s1">    # directive is specifying another file :/
</span></span></span><span class="line"><span class="cl"><span class="s1">    mkdir -p var/log/nginx
</span></span></span><span class="line"><span class="cl"><span class="s1">  &#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Cmd</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&#34;nginx&#34;</span> <span class="s2">&#34;-c&#34;</span> <span class="n">conf</span><span class="o">.</span><span class="n">nginxConf</span> <span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">ExposedPorts</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&#34;</span><span class="si">${</span><span class="n">conf</span><span class="o">.</span><span class="n">nginxPort</span><span class="si">}</span><span class="s2">/tcp&#34;</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>With the above declared, we can run <code>nix-build</code> and create an image.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">nix-build nginx-container.nix
</span></span></code></pre></div><p>This will create a multi-layer image and create a symlink named <code>result</code>. You
can now load the tarball into a container tool like <code>docker</code> and push it to a
remote repository.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker load &lt; result
</span></span><span class="line"><span class="cl">docker push joshrosso/kubecon:1.4
</span></span></code></pre></div><p>In my Kubecon talk (video above) I validated the container's functionality by
deploying the pod, then port-forwarding to it and opening it in a web browser.</p>
<p>The manifest looked as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">a-message-from-the-underworld</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">message</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">joshrosso/kubecon:1.4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><p>The port-forward command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl port-forward --address 0.0.0.0 pods/a-message-from-the-underworld 8080:80
</span></span></code></pre></div><p>The app could then be opened in a web browser as seen below.</p>
<img src="https://web.archive.org/web/20231208145439im_/https://files.joshrosso.com/img/site/nix-k8s/hades-demo.png">
<h2 id="next-steps">Next Steps</h2>
<p>There's a lot more to explore in the Nix ecosystem, but here are some specific
things you may wish to look into if you decided to build on what's in this
guide.</p>
<ol>
<li>Add non-root users to your hypervisor and VMs.</li>
<li>Read <a href="https://web.archive.org/web/20231208145439/https://nixos.org/guides/nix-pills/">nix-pills</a> to better understand the language, packages, and OS.</li>
<li>Checkout farcaller's NixCon talk on <a href="https://web.archive.org/web/20231208145439/https://www.youtube.com/watch?v=SEA1Qm8K4gY">Kuberentes deployments with
Nix</a>, it covers using Nix for
manifest generation.</li>
<li>Consider running NixOS on your desktop/laptop.</li>
</ol>
</div>
<div class="content-toc">
<h3>Contents</h3>
<nav id="TableOfContents">
<ul>
<li><a href="index.html#hypervisor">Hypervisor</a>
<ul>
<li><a href="index.html#os-install-via-iso">OS Install via ISO</a></li>
<li><a href="index.html#networking-and-software">Networking and Software</a></li>
</ul>
</li>
<li><a href="index.html#vm">VM</a></li>
<li><a href="index.html#containers">Containers</a></li>
<li><a href="index.html#next-steps">Next Steps</a></li>
</ul>
</nav>
</div>
</div>
</body>
</html>
<!--
     FILE ARCHIVED ON 14:54:39 Dec 08, 2023 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 03:15:47 Sep 10, 2024.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 0.44
  exclusion.robots: 0.017
  exclusion.robots.policy: 0.008
  esindex: 0.008
  cdx.remote: 4.859
  LoadShardBlock: 82.232 (3)
  PetaboxLoader3.datanode: 50.772 (4)
  PetaboxLoader3.resolve: 117.947 (2)
  load_resource: 112.357
-->
